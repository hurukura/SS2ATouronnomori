<?php

?>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="css/c_home.css">
	<title>討論の杜</title>
</head>

<body>

	<!--    モジュール   -->

	<!--    firebase関連   -->
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-firestore.js"></script>

	<!--    モジュールここまで   -->

	<script src="js/config.js"></script>
	<script>
		var userid = "";

	</script>

	<div class="home">
		<div id="info"></div>
		<form>
			<button type="button" id="logout" class="hide">ログアウト</button>
		</form>
		<h1>討論の杜</h1>
		<h2 id="welcom">...Please wait</h2>

		<h3 style="text-align: center">現在行われている討論</h3>
		<!-- <div id="maintable"></div>-->
		<table class="discussion_table" id="roomtable" border="1" frame="void" width="400" height="250">
			<tr>
				<th>No.</th>
				<th>お題</th>
				<th>参加人数</th>
				<th>参加/観戦</th>
			</tr>
			<tr>
				<td align='center'>1</td>
				<td align='center'>
					<div id='room1'></div>
				</td>
				<td align='center'>
					<div id='count1'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(1,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(1)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>2</td>
				<td align='center'>
					<div id='room2'></div>
				</td>
				<td align='center'>
					<div id='count2'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(2,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(2)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>3</td>
				<td align='center'>
					<div id='room3'></div>
				</td>
				<td align='center'>
					<div id='count3'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(3,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(3)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>4</td>
				<td align='center'>
					<div id='room4'></div>
				</td>
				<td align='center'>
					<div id='count4'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(4,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(4)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>5</td>
				<td align='center'>
					<div id='room5'></div>
				</td>
				<td align='center'>
					<div id='count5'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(5,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(5)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>6</td>
				<td align='center'>
					<div id='room6'></div>
				</td>
				<td align='center'>
					<div id='count6'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(6,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(6)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>7</td>
				<td align='center'>
					<div id='room7'></div>
				</td>
				<td align='center'>
					<div id='count7'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(7,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(7)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>8</td>
				<td align='center'>
					<div id='room8'></div>
				</td>
				<td align='center'>
					<div id='count8'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(8,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(8)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>9</td>
				<td align='center'>
					<div id='room9'></div>
				</td>
				<td align='center'>
					<div id='count9'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(9,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(9)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>10</td>
				<td align='center'>
					<div id='room10'></div>
				</td>
				<td align='center'>
					<div id='count10'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(10,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(10)' value='観戦' /></td>
			</tr>
		</table>

		<a id="setting_yudo" href="acount_setting.html">アカウントの設定</a>


	</div>


	<!--	ここからJavaScript		-->
	<script src="js/auth.js"></script>

	<!--FireStoreからルーム情報を取得-->
	<script>
		//参加ボタンでトークに参加
		//参加人数を集計しdiscussion_goに渡す	snapshotにラグがあるためこの関数を追加
		function discussion(id, userid) {
			var c = 0;
			var a_user
			const db = firebase.firestore();
			const docRef = db.collection("chatroom").doc("room" + id).collection("roominfo").doc("room" + id);
			docRef.get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					a_user = Object.entries(doc.data().users);
					c = Object.entries(doc.data().users).length;
					console.log(c);
					discussion_go(id, userid, c, a_user);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
		}

		//人数に空きがある場合又はすでに参加している場合、参加可能になる
		function discussion_go(id, userid, counter, a_user) {
			var a = 1;
			var user0 = "",
				user1 = "",
				user2 = "",
				user3 = "",
				user4 = "";
			//user0~4に参加者のuseridを入れる
			for (var i = 0; i < counter; i++) {
				switch (i) {
					case 0:
						user0 = a_user[i][1];
						break;
					case 1:
						user1 = a_user[i][1];
						break;
					case 2:
						user2 = a_user[i][1];
						break;
					case 3:
						user3 = a_user[i][1];
						break;
					case 4:
						user4 = a_user[i][1];
						break;
				}
			}
			if (counter < 5 || user0 == userid || user1 == userid || user2 == userid || user3 == userid || user4 == userid) {//人数に空きがある場合又はすでに参加している場合
				ret = confirm("ルーム" + id + "に移動します");
				if (ret == true) {

					//ユーザーIDをFirestoreに追加
					const db = firebase.firestore();
					const docRef = db.collection("chatroom").doc("room" + id).collection("roominfo").doc("room" + id);
					docRef.update({
						users: firebase.firestore.FieldValue.arrayUnion(userid)
					})
						.then(function() {
						console.log("Document successfully written!");
					})
						.catch(function(error) {
						console.error("Error writing document: ", error);
					});

					location.href = "http://localhost/SS2ATouronnomori/discussion.html?&&room" + id;
				}
			} else {
				ret = confirm("ルームは満員です");
			}
		}

		//観戦ボタンでトークを見る
		function participation(id) {
			var a = 1;
			ret = confirm("ルーム" + id + "に移動します");
			if (ret == true) {
				location.href = "http://localhost/SS2ATouronnomori/discussion.html?&&room" + id + "&&par";

			}
		}

		//ルーム情報を表示
		var db = firebase.firestore();
		var docRef = db.collection("chatroom");
		docRef.get().then((query) => {
			query.forEach((doc) => {});
			var messagesRef = db.collection("chatroom");
			//room1~10まで表示（for文で回せずそれぞれ記載）
			messagesRef.doc("room1").collection("roominfo").doc("room1").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room1";
					var count = "count1";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room2").collection("roominfo").doc("room2").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room2";
					var count = "count2";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room3").collection("roominfo").doc("room3").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room3";
					var count = "count3";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room4").collection("roominfo").doc("room4").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room4";
					var count = "count4";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room5").collection("roominfo").doc("room5").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room5";
					var count = "count5";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room6").collection("roominfo").doc("room6").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room6";
					var count = "count6";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room7").collection("roominfo").doc("room7").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room7";
					var count = "count7";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room8").collection("roominfo").doc("room8").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room8";
					var count = "count8";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room9").collection("roominfo").doc("room9").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room9";
					var count = "count9";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room10").collection("roominfo").doc("room10").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room10";
					var count = "count10";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
		}).catch((error) => {
			console.log(`データの取得に失敗しました (${error})`);
		});

		//ルーム情報を表示
		function addlog(data, room, count) {
			var str = data.theme;
			console.log(typeof str);
			var cnt = Object.entries(data.users);
			console.log(cnt.length);
			document.querySelector(`#${room}`).innerText = str; //お題
			document.querySelector(`#${count}`).innerText = String(cnt.length); //参加人数
		}

	</script>

</body>
