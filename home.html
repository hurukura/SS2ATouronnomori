<?php

?>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="css/c_home.css">
	<title>討論の杜</title>
</head>

<body>

	<!--    モジュール   -->

	<!--    firebase auth   -->
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

	<!--    firestoe    -->
	<script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-firestore.js"></script>

	<!--    モジュールここまで   -->

	<script>
		var firebaseConfig = { // 共有アカウント
			apiKey: "AIzaSyCKJKx0gUnD2qBB3cdyk_wZ8bJAwdeqFWw",
			authDomain: "touronnomori.firebaseapp.com",
			databaseURL: "https://touronnomori.firebaseio.com",
			projectId: "touronnomori",
			storageBucket: "touronnomori.appspot.com",
			messagingSenderId: "638781936294",
			appId: "1:638781936294:web:32215a2b2d87370fb5da67",
			measurementId: "G-F5WWPJ82Q4"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);

	</script>


	<div class="home">
		<div id="info"></div>
		<form>
			<button type="button" id="logout" class="hide">ログアウト</button>
		</form>
		<h1>討論の杜</h1>
		<h2>...Please wait</h2>

		<h3 style="text-align: center">現在行われている討論</h3>
		<!-- <div id="maintable"></div>-->
		<table class="discussion_table" id="roomtable" border="1" frame="void" width="400" height="250">
			<tr>
				<th>No.</th>
				<th>お題</th>
				<th>参加人数</th>
				<th>参加/観戦</th>
			</tr>
			<tr>
				<td align='center'>1</td>
				<td align='center'>
					<div id='room1'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(1)' value='参加' /><input type='button' name='kansenroom' onclick='participation(1)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>2</td>
				<td align='center'>
					<div id='room2'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(2)' value='参加' /><input type='button' name='kansenroom' onclick='participation(2)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>3</td>
				<td align='center'>
					<div id='room3'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(3)' value='参加' /><input type='button' name='kansenroom' onclick='participation(3)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>4</td>
				<td align='center'>
					<div id='room4'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(4)' value='参加' /><input type='button' name='kansenroom' onclick='participation(4)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>5</td>
				<td align='center'>
					<div id='room5'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(5)' value='参加' /><input type='button' name='kansenroom' onclick='participation(5)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>6</td>
				<td align='center'>
					<div id='room6'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(6)' value='参加' /><input type='button' name='kansenroom' onclick='participation(6)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>7</td>
				<td align='center'>
					<div id='room7'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(7)' value='参加' /><input type='button' name='kansenroom' onclick='participation(7)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>8</td>
				<td align='center'>
					<div id='room8'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(8)' value='参加' /><input type='button' name='kansenroom' onclick='participation(8)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>9</td>
				<td align='center'>
					<div id='room9'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(9)' value='参加' /><input type='button' name='kansenroom' onclick='participation(9)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>10</td>
				<td align='center'>
					<div id='room10'></div>
				</td>
				<td align='center'>2</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(10)' value='参加' /><input type='button' name='kansenroom' onclick='participation(10)' value='観戦' /></td>
			</tr>
		</table>

		<a id="setting_yudo" href="acount_setting.html">アカウントの設定</a>


	</div>


	<!--	ここからJavaScript		-->
	<script>
		firebase.auth().onAuthStateChanged((user) => {
			let logout = document.getElementById("logout");

			//-----------------------------------
			// ログインチェック
			//-----------------------------------
			if (!user) {
				showMessage('Not Login', 'ログインしていません');
				logout.classList.add("hide");
				window.location.href = 'login.html';
				return (false);
			}

			//-----------------------------------
			// ログイン者への処理
			//-----------------------------------
			// ログインメッセージ
			showMessage('ようこそ！', `ログイン中 : ${user.displayName}さん`);
			console.log(user);

			// ログアウトボタンを表示
			logout.classList.remove("hide");

			// ログアウトボタンを押下
			logout.addEventListener("click", () => {
				firebase.auth().signOut().then(() => {
						console.log("ログアウトしました");

						//アラートを表示
						window.alert('ログアウトしました。またきてね');
						//OKでログイン画面へ遷移
						window.location.href = 'login.html'
					})
					.catch((error) => {
						console.log(`ログアウト時にエラーが発生しました (${error})`);
					});
			});
		});
		/**
		 * メッセージ表示
		 **/
		function showMessage(title, msg) {
			document.querySelector('h2').innerText = title;
			document.querySelector('#info').innerText = msg;
		}

	</script>

	<!--FireStoreからルーム情報を取得-->
	<script>
		//参加ボタンでトークに参加
		function discussion(id) {
			var a = 1;
			ret = confirm("ルーム" + id + "に移動します");
			if (ret == true) {
				location.href = "http://localhost/Touronnomori/kaihatsu/discussion.html?&&room" + id;
			}
		}
		//観戦ボタンでトークを見る
		function participation(id) {
			var a = 1;
			ret = confirm("ルーム" + id + "に移動します");
			if (ret == true) {
				location.href = "http://localhost/Touronnomori/kaihatsu/discussion.html?&&room" + id + "&&par";

			}
		}


		var db = firebase.firestore();
		var room = [];
		var docRef = db.collection("chatroom");
		docRef.get().then((query) => {
					query.forEach((doc) => {

						var data = doc.data();
						room.push(doc.id);
					});
					console.log(room);




						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room1").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room1";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room2").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room2";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room3").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room3";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room4").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room4";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room5").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room5";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room6").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room6";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room7").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room7";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room8").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room8";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room9").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room9";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
						var messagesRef = db.collection("chatroom");
						messagesRef.doc("room10").collection("theme").onSnapshot((snapshot) => {
							snapshot.docChanges().forEach((change) => {
								// 追加
								if (change.type === 'added') {
									var room = "room10";
									addLog(change.doc.id, change.doc.data(), room);
								}
							});
						});
		}).catch((error) => {
					console.log(`データの取得に失敗しました (${error})`);
				});

	</script>
	<script>
		function addLog(id, data, room) {
			// 追加するHTMLを作成


			var str = data.odai;
			console.log(room);

			document.querySelector(`#${room}`).innerText = str;
		}

	</script>

</body>
