<?php

?>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="css/c_home.css">
	<title>討論の杜</title>
</head>

<body>

	<!--    モジュール   -->

	<!--    firebase auth   -->
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

	<!--    firestoe    -->
	<script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-firestore.js"></script>

	<!--    モジュールここまで   -->

	<script>
		var firebaseConfig = { // 共有アカウント
			apiKey: "AIzaSyCKJKx0gUnD2qBB3cdyk_wZ8bJAwdeqFWw",
			authDomain: "touronnomori.firebaseapp.com",
			databaseURL: "https://touronnomori.firebaseio.com",
			projectId: "touronnomori",
			storageBucket: "touronnomori.appspot.com",
			messagingSenderId: "638781936294",
			appId: "1:638781936294:web:32215a2b2d87370fb5da67",
			measurementId: "G-F5WWPJ82Q4"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);

	</script>
	<script>
		var userid = "";

	</script>


	<div class="home">
		<div id="info"></div>
		<form>
			<button type="button" id="logout" class="hide">ログアウト</button>
		</form>
		<h1>討論の杜</h1>
		<h2>...Please wait</h2>

		<h3 style="text-align: center">現在行われている討論</h3>
		<!-- <div id="maintable"></div>-->
		<table class="discussion_table" id="roomtable" border="1" frame="void" width="400" height="250">
			<tr>
				<th>No.</th>
				<th>お題</th>
				<th>参加人数</th>
				<th>参加/観戦</th>
			</tr>
			<tr>
				<td align='center'>1</td>
				<td align='center'>
					<div id='room1'></div>
				</td>
				<td align='center'>
					<div id='count1'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(1,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(1)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>2</td>
				<td align='center'>
					<div id='room2'></div>
				</td>
				<td align='center'>
					<div id='count2'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(2,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(2)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>3</td>
				<td align='center'>
					<div id='room3'></div>
				</td>
				<td align='center'>
					<div id='count3'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(3,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(3)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>4</td>
				<td align='center'>
					<div id='room4'></div>
				</td>
				<td align='center'>
					<div id='count4'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(4,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(4)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>5</td>
				<td align='center'>
					<div id='room5'></div>
				</td>
				<td align='center'>
					<div id='count5'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(5,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(5)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>6</td>
				<td align='center'>
					<div id='room6'></div>
				</td>
				<td align='center'>
					<div id='count6'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(6,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(6)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>7</td>
				<td align='center'>
					<div id='room7'></div>
				</td>
				<td align='center'>
					<div id='count7'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(7,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(7)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>8</td>
				<td align='center'>
					<div id='room8'></div>
				</td>
				<td align='center'>
					<div id='count8'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(8,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(8)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>9</td>
				<td align='center'>
					<div id='room9'></div>
				</td>
				<td align='center'>
					<div id='count9'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(9,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(9)' value='観戦' /></td>
			</tr>
			<tr>
				<td align='center'>10</td>
				<td align='center'>
					<div id='room10'></div>
				</td>
				<td align='center'>
					<div id='count10'></div>
				</td>
				<td align='center'><input type='button' name='chatroom' onclick='discussion(10,userid)' value='参加' /><input type='button' name='kansenroom' onclick='participation(10)' value='観戦' /></td>
			</tr>
		</table>

		<a id="setting_yudo" href="acount_setting.html">アカウントの設定</a>


	</div>


	<!--	ここからJavaScript		-->
	<script>
		firebase.auth().onAuthStateChanged((user) => {
			let logout = document.getElementById("logout");

			//-----------------------------------
			// ログインチェック
			//-----------------------------------
			if (!user) {
				showMessage('Not Login', 'ログインしていません');
				logout.classList.add("hide");
				window.location.href = 'login.html';
				return (false);
			}

			//-----------------------------------
			// ログイン者への処理
			//-----------------------------------
			// ログインメッセージ
			showMessage('ようこそ！', `ログイン中 : ${user.displayName}さん`);
			console.log(user);

			userid = user.uid;
			console.log(userid);

			// ログアウトボタンを表示
			logout.classList.remove("hide");

			// ログアウトボタンを押下
			logout.addEventListener("click", () => {
				firebase.auth().signOut().then(() => {
						console.log("ログアウトしました");

						//アラートを表示
						window.alert('ログアウトしました。またきてね');
						//OKでログイン画面へ遷移
						window.location.href = 'login.html'
					})
					.catch((error) => {
						console.log(`ログアウト時にエラーが発生しました (${error})`);
					});
			});
		});
		/**
		 * メッセージ表示
		 **/
		function showMessage(title, msg) {
			document.querySelector('h2').innerText = title;
			document.querySelector('#info').innerText = msg;
		}

	</script>

	<!--FireStoreからルーム情報を取得-->
	<script>
		//参加ボタンでトークに参加
		function discussion(id, userid) {
			var a = 1;
			ret = confirm("ルーム" + id + "に移動します");
			if (ret == true) {

				//ユーザーIDをFirestoreに追加
				const db = firebase.firestore();
				const docRef = db.collection("chatroom").doc("room" + id).collection("roominfo").doc("room" + id);
				docRef.update({
						users: firebase.firestore.FieldValue.arrayUnion(userid)
					})
					.then(function() {
						console.log("Document successfully written!");
					})
					.catch(function(error) {
						console.error("Error writing document: ", error);
					});

				//				location.href = "http://localhost/SS2ATouronnomori/discussion.html?&&room" + id;
			}
		}
		//観戦ボタンでトークを見る
		function participation(id) {
			var a = 1;
			ret = confirm("ルーム" + id + "に移動します");
			if (ret == true) {
				location.href = "http://localhost/SS2ATouronnomori/discussion.html?&&room" + id + "&&par";

			}
		}


		var db = firebase.firestore();
		var room = [];
		var docRef = db.collection("chatroom");
		docRef.get().then((query) => {
			query.forEach((doc) => {

				var data = doc.data();
				room.push(doc.id);
			});
			console.log(room);




			var messagesRef = db.collection("chatroom");
			messagesRef.doc("room1").collection("roominfo").doc("room1").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room1";
					var count = "count1";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room2").collection("roominfo").doc("room2").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room2";
					var count = "count2";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room3").collection("roominfo").doc("room3").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room3";
					var count = "count3";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room4").collection("roominfo").doc("room4").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room4";
					var count = "count4";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room5").collection("roominfo").doc("room5").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room5";
					var count = "count5";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room6").collection("roominfo").doc("room6").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room6";
					var count = "count6";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room7").collection("roominfo").doc("room7").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room7";
					var count = "count7";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room8").collection("roominfo").doc("room8").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room8";
					var count = "count8";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room9").collection("roominfo").doc("room9").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room9";
					var count = "count9";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			messagesRef.doc("room10").collection("roominfo").doc("room10").get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var room = "room10";
					var count = "count10";
					addlog(doc.data(), room, count);
				} else {
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
		}).catch((error) => {
			console.log(`データの取得に失敗しました (${error})`);
		});

	</script>
	<script>

		function addlog(data, room, count) {
			var str = data.theme;
			console.log(typeof str);
			var cnt = Object.entries(data.users);
			console.log(cnt.length);
			document.querySelector(`#${room}`).innerText = str;
			document.querySelector(`#${count}`).innerText = String(cnt.length);
		}

	</script>

</body>
