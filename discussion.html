<!--
参考資料
https://qiita.com/taketakekaho/items/52b7c196ddbd4cb3c968
-->
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="css/c_discussion.css">
	<title>FireStore Chat</title>

</head>

<body>
	<div id="info"></div>
	<form>
		<button type="button" id="logout" class="hide">ログアウト</button>
		<h1>討論の杜</h1>
	</form>

	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-firestore.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>

	<script src="js/config.js">
	</script>
	<script>
		var uname;
		var userid;
		firebase.auth().onAuthStateChanged((user) => {
			let logout = document.getElementById("logout");

			//-----------------------------------
			// ログインチェック
			//-----------------------------------
			if (!user) {
				showMessage('Not Login', 'ログインしていません');
				logout.classList.add("hide");
				window.location.href = 'login.html';
				return (false);
			}

			//-----------------------------------
			// ログイン者への処理
			//-----------------------------------
			// ログインメッセージ
			showMessage(`ログイン中 : ${user.displayName}さん`);
			console.log(user);

			//unameにユーザー名表示
			uname = user.displayName;
			document.querySelector('#uname').innerText = uname;

			userid = user.uid;
			console.log(userid);

			// ログアウトボタンを表示
			logout.classList.remove("hide");

			// ログアウトボタンを押下
			logout.addEventListener("click", () => {
				firebase.auth().signOut().then(() => {
						console.log("ログアウトしました");

						//アラートを表示
						window.alert('ログアウトしました。またきてね');
						//OKでログイン画面へ遷移
						window.location.href = 'login.html'
					})
					.catch((error) => {
						console.log(`ログアウト時にエラーが発生しました (${error})`);
					});
			});
		});
		/**
		 * メッセージ表示
		 **/
		function showMessage(msg) {
			document.querySelector('#info').innerText = msg;
		}

	</script>

	<!--参加ユーザーの表示-->
	<script>
		//遷移元から値（ルームid）を受け取る
		var query = location.search;
		var value = query.split('?&&');
		var a = new Array();

		console.log("value = " + value);

		//ルームidの定義
		var roomid = value[1];
		console.log("roomid = " + roomid);

		//db定義
		var db = firebase.firestore();
		const docRef0 = db.collection("chatroom").doc(roomid);

		//参加ユーザーのuid用の配列定義
		var P_users;

		docRef0.onSnapshot(function(doc) {
			console.log("Current data: ", doc.data());
			P_users = doc.data();
			P_users = P_users.users;
			console.log("P_users:" + P_users);
			usersssss(P_users.length,roomid);

		});




		function usersssss(len,roomid) {
			//配列からそれぞれ参加ユーザーごとのaタグを生成
			for (i = 0; i < len; i++) {
				console.log('ユーザーID=' + P_users[i]);

				//iのuid定義
				var uid = P_users[i];
				
				//aタグ生成
				var a = '<a href="acount_info.html?uid=' + P_users[i] + '" id="user' + i + '" >'a'</a><br>';
				
				var ab = '<a href="acount_info.html?uid=${}">${}</a><br>';
				
				//			aタグのid定義
				var U_id = '#user' + i;
				console.log("U_id:"+U_id);

				let Btn_user = document.querySelector(U_id);

				console.log(a);
				
				var Ataguser_docRef = db.collection("chatroom").doc(roomid).collection("roominfo").doc(roomid);
			
				Ataguser_docRef.update({
					//　ここにDBへの書き込みコード
					name: 

				})
					.then(function() {
					console.log("Document successfully written!");
				})
					.catch(function(error) {
					console.error("Error writing document: ", error);
				});
				
				
				
//				btn_name(U_id, P_users[i]);
			}
		}

//		function btn_name(id, Pname) {
//			//db定義
//			const docRef = db.collection("users").doc(Pname);
//			//データの読み取り
//			docRef.get().then((doc) => {
//					if (doc.exists) {
//						console.log(doc.data());
//						let name = doc.data()["username"];
//						console.log(name);
//						document.querySelector(id).textContent = name;
//					} else {
//						console.log("404");
//					}
//				})
//				.catch((error) => {
//					console.log(`データを取得できませんでした (${error})`);
//				});
//		}

	</script>

	<!-- 発言が表示される領域 -->
	<div id="your_container">
		<div id="bms_messages">
		</div>
	</div>

	<!-- 入力フォーム -->
	<form id="form1">
		<div id="uname"></div>
		<div id="bms_send">
			<textarea id="bms_send_message"></textarea>
			<div id="radio">
				<input type="radio" name="flag" value="0">賛成
				<br><input type="radio" name="flag" value="1">反対
			</div>
			<div id="bms_send_btn">送信</div>
		</div>
	</form>

	<!-- 以下script -->
	<script>
		//---------------------------------------
		// チャット初期処理
		//---------------------------------------

		//観戦
		var del = location.search.split('&&');
		console.log(del);


		// 要素を取得
		if (del[2] == 'par') {
			let id1 = document.getElementById('form1');
			// 現在の display プロパティの値を保持
			const displayOriginal = id1.style.display;
			// none に設定して非表示
			id1.style.display = 'none';
		}
		/////


		//---------------------------------------
		// Firestoreの準備
		//---------------------------------------
		// Firestoreのインスタンス作成
		//			var db = firebase.firestore();

		// チャットルームのリファレンス取得
		//    ★home.phpで選択したルームIDを ここ↓  に入れる
		console.log(del[1]);
		var db = firebase.firestore();
		var messagesRef = db.collection("chatroom").doc(del[1]).collection("messages");

		/**
		 * 同期処理
		 **/
		messagesRef.orderBy("date", "asc").limit(20).onSnapshot((snapshot) => {
			snapshot.docChanges().forEach((change) => {
				// 追加
				if (change.type === 'added') {
					addLog(change.doc.id, change.doc.data());
				}
				// 更新
				else if (change.type === 'modified') {
					modLog(change.doc.id, change.doc.data());
				}
				// 削除
				else if (change.type === 'removed') {
					removeLog(change.doc.id);
				}
			});
		});

		/**
		 * 送信ボタン押下
		 **/
		document.getElementById("bms_send_btn").addEventListener("click", () => {
			let msg = document.getElementById("bms_send_message").value;
			if (msg.length === 0) {
				return (false);
			}
			let flag = document.getElementById("form1").flag.value;
			if (flag.length === 0) {
				console.log(flag);
				return (false);
			}
			// メッセージをfirestoreへ送信
			messagesRef.add({
					name: uname,
					msg: msg,
					flag: flag,
					date: new Date().getTime(),
					id: userid
				})
				.then(() => {
					let msg = document.getElementById("bms_send_message");
					msg.focus();
					msg.value = "";
				})
		});
		// submitイベントは（いったん）無視する
		document.getElementById("form1").addEventListener("submit", (e) => {
			e.preventDefault();
		});


		/**
		 * ログに追加
		 */
		function addLog(id, data) {
			// 追加するHTMLを作成

			if (data.name == uname) {
				if (data.flag == 0) {
					var str = `<div class="bms_message bms_right bms_mine"><div class="bms_message_box"><div class="bms_message_content"><div class="bms_message_name"><a href="acount_info.html?uid=${data.id}">${data.name}</a></div><div class="bms_message_text">${data.msg} </div></div></div></div><div class="bms_clear"></div>`;
					console.log(data.id);
				} else {
					var str = `<div class="bms_message bms_left bms_mine"><div class="bms_message_box"><div class="bms_message_content"><div class="bms_message_name"><a href="acount_info.html?uid=${data.id}">${data.name}</a></div><div class="bms_message_text">${data.msg} </div></div></div></div><div class="bms_clear"></div>`;
				}
			} else {
				if (data.flag == 0) {
					var str = `<div class="bms_message bms_right"><div class="bms_message_box"><div class="bms_message_content"><div class="bms_message_name"><a href="acount_info.html?uid=${data.id}">${data.name}</a></div><div class="bms_message_text">${data.msg} </div></div></div></div><div class="bms_clear"></div>`;
				} else {
					var str = `<div class="bms_message bms_left"><div class="bms_message_box"><div class="bms_message_content"><div class="bms_message_name"><a href="acount_info.html?uid=${data.id}">${data.name}</a></div><div class="bms_message_text">${data.msg} </div></div></div></div><div class="bms_clear"></div>`;
				}
			}
			document.getElementById("bms_messages").innerHTML += str;
		}

		/**
		 * ログを更新
		 */
		function modLog(id, data) {
			let log = document.getElementById(id);
			if (log !== null) {
				log.innerText = `${data.name}: ${data.msg} (${getStrTime(data.date)})`;

				if (data.flag == 0) {
					var str = `<div class="bms_message bms_right"><div class="bms_message_box"><div class="bms_message_content"><div class="bms_message_text"><a href="acount_info.html?uid=${data.id}">${data.name}</a><br><br>${data.msg} </div></div></div></div><div class="bms_clear"></div>`;
				} else {
					var str = `<div class="bms_message bms_left"><div class="bms_message_box"><div class="bms_message_content"><div class="bms_message_text"><a href="acount_info.html?uid=${data.id}">${data.name}</a><br><br>${data.msg} </div></div></div></div><div class="bms_clear"></div>`;
				}
			}
		}

		/**
		 * ログを削除
		 **/
		function removeLog(id) {
			let log = document.getElementById(id);
			if (log !== null) {
				log.parentNode.removeChild(log);
			}
		}

		/**
		 * UNIX TIME => MM-DD hh:mm
		 **/
		function getStrTime(time) {
			let t = new Date(time);
			return (
				("0" + (t.getMonth() + 1)).slice(-2) + "-" +
				("0" + t.getDate()).slice(-2) + " " +
				("0" + t.getHours()).slice(-2) + ":" +
				("0" + t.getMinutes()).slice(-2)
			);
		}

	</script>
</body>

</html>
